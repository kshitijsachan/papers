#!/bin/bash
# Start papers app
# Usage:
#   papers        - start if needed, open browser
#   papers --dev  - kill existing, restart with hot reload, foreground

BACKEND_DIR="/Users/kshitij/code/misc/papers/backend"
FRONTEND_DIR="/Users/kshitij/code/misc/papers/frontend"

# Dev mode: kill, restart with hot reload, run in foreground
if [[ "$1" == "--dev" || "$1" == "-d" ]]; then
    echo "Stopping existing servers..."
    pkill -f "uvicorn main:app" 2>/dev/null
    pkill -f "vite" 2>/dev/null
    sleep 1

    echo "Starting in dev mode (Ctrl+C to stop)..."

    # Start backend with hot reload
    cd "$BACKEND_DIR" && uv run uvicorn main:app --port 8000 --reload &
    BACKEND_PID=$!

    # Start frontend (vite already has hot reload)
    cd "$FRONTEND_DIR" && npm run dev &
    FRONTEND_PID=$!

    # Wait for servers then open browser
    sleep 3
    open http://localhost:5173

    # Wait for Ctrl+C, then cleanup
    trap "echo 'Stopping...'; kill $BACKEND_PID $FRONTEND_PID 2>/dev/null; exit" INT
    wait
    exit 0
fi

# Normal mode: start if needed, background
if ! curl -s http://127.0.0.1:8000/papers > /dev/null 2>&1; then
    echo "Starting backend..."
    cd "$BACKEND_DIR" && uv run uvicorn main:app --port 8000 > /tmp/papers-backend.log 2>&1 &
    sleep 2
fi

if ! curl -s http://127.0.0.1:5173 > /dev/null 2>&1; then
    echo "Starting frontend..."
    cd "$FRONTEND_DIR" && npm run dev > /tmp/papers-frontend.log 2>&1 &
    sleep 2
fi

# Wait for servers to be ready
for i in {1..10}; do
    if curl -s http://127.0.0.1:8000/papers > /dev/null 2>&1 && \
       curl -s http://127.0.0.1:5173 > /dev/null 2>&1; then
        break
    fi
    sleep 1
done

open http://localhost:5173
